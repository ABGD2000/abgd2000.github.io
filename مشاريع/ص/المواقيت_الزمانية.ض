تحميل "stdlib.ring"
تحميل "حساب.ض"
تحميل "الزمن.ض"

oMath = أعمل Math


قيم_ابتدئية = [
    :الإمساك = "0 أقل" ,
    :الفجر = "19.5" ,
    :العشاء = "17.5" ,
    :المغرب = "" ,
    :نص_اليل = "" ,
    :الظهر = "0 أقل" ,
    :العصر = "Standard" , 
    :أعلي_خظ_عرض = "على أساس الزاوية" ,
]


 استدار_الزمن_اليومي  = قيم_ابتدئية

 الأسلوب = [
    :الإسم = "" , 
    :القيم = فارغ , 
    :قيم_زوايا = [] , 
]


بيانات_مواقيت_الصلاة = [
    :الوسائل = [] ,
    :الإعدادات =   استدار_الزمن_اليومي ,
    :قيم_زوايا = [0, 0, 0, 0, 0, 0, 0,0,0] ,
    :ألية_المستخدمة = "" ,
    :نسق_الساعة = "24h" ,
    :تمييز_المعاد = ["", ""] ,
    :خطأ_التوقيت = "" ,
    :الرقم_الدوران = 1 ,
    :فرق_التوقيت = 0 , 
    :دائرة_العرض = 0 ,
    :خط_الطول = 0 ,
    :زواية_النظر_للبحر = 0 ,
    :اليوم_المكاني = 0 ,
]

أسماء_الزمن = [
    "الإمساك", "الفجر", "الشروق", "الظهر", "العصر", "الغروب", "المغرب", "العشاء", "نص_اليل"
]


الوسائل = [
 
]

الزمن =  بيانات_مواقيت_الصلاة

دالة هل_أقل س
    مرر substr(س, "أقل") != 0
تمام



دالة متساوي s1, s2
    مرر s1 = s2
تمام

دالة مجال a, mode
    a = a - mode * صحيح(a / mode)
    لو a < 0
        مرر a + mode
    لا
        مرر a
    تمام
تمام

دالة مجال_الزاوية الزاوية
     شوف "مجال_الزاوية : " + الزاوية + سطر 
    مرر مجال(الزاوية, 360.0)
تمام

دالة مجال_الساعة الساعة
    مرر مجال(الساعة, 24.0)
تمام

دالة ميلادي عام, شهر, يوم
    لو شهر <= 2
        عام -= 1
        شهر += 12
    تمام
    س = صحيح(عام / 100)
    ص = 2 - س + صحيح(س / 4)
    ص_عام= صحيح(365.25 * (عام + 4716))
    ص_شهر= صحيح(30.6001 * (شهر + 1)) 
    
    مرر ص_عام + ص_شهر + يوم + ص - 1524.5
تمام

دالة مكان_الشمس التاريخ
شوف "مكان_الشمس" + سطر
    نقطة_دورن = القيمة(التاريخ) - 2451545.0  //  اليوم_الجليدي (Al-Yawm_Al-Jalaydi) - يشير إلى عدد الأيام منذ نقطة مرجعية (J2000.0).
    شوف "مكان_الشمس$1" + سطر
    متوسط_المداري_الشمسي = مجال_الزاوية(357.529 + 0.98560028 * نقطة_دورن)
    خط_طول_الشمس_الظاهري = مجال_الزاوية(280.459 + 0.98564736 * نقطة_دورن)
    خط_طول_الشمس_الحقيقي = مجال_الزاوية(خط_طول_الشمس_الظاهري + 1.915 * جا(متوسط_المداري_الشمسي * ط / 180) + 0.020 * جا(2 * متوسط_المداري_الشمسي * ط / 180))
    ميل_المحور_الأرضي = 23.439 - 0.00000036 * نقطة_دورن
 شوف "مكان_الشمس$7" + سطر
    المطلع_المستقيم_للشمس = (oMath.atan2(جتا(ميل_المحور_الأرضي * ط / 180) * جا(خط_طول_الشمس_الحقيقي * ط / 180), جتا(خط_طول_الشمس_الحقيقي * ط / 180))*  180/ ط) / 15.0 
    
   شوف "مكان_الشمس$8" + سطر
    الوقت_الشمسي = خط_طول_الشمس_الظاهري / 15.0 - مجال_الساعة(المطلع_المستقيم_للشمس)
    موقع_الشمس = (قوس_الجيب(جا(ميل_المحور_الأرضي * ط / 180) * جا(خط_طول_الشمس_الحقيقي * ط / 180))*  180/ ط )
      شوف "مكان_الشمس$9" + سطر
    مرر [موقع_الشمس , الوقت_الشمسي]
    
تمام

دالة نصف_اليوم الوقت
    الوقت_الشمسي = مكان_الشمس(الزمن[:اليوم_المكاني] + الوقت)[2] 
    شوف "-----------------------------" + سطر
    مرر مجال_الساعة(12 - الوقت_الشمسي)
تمام



دالة مستوي_الشمس الزاوية, الوقت, الأتجاه
    شوف "مستوي_الشمس" + سطر 
    موقع_الشمس = مكان_الشمس(الزمن[:اليوم_المكاني] + الوقت)[1] 
        شوف "مستوي_الشمس$1" + سطر 
    الظهيرة = نصف_اليوم(الوقت)
    معدل_التغير = (1 / 15.0) * قوس_جيب_التمام((-جا(الزاوية * ط / 180) - جا(موقع_الشمس * ط / 180) * جا(الزمن[:دائرة_العرض] * ط / 180)) / (جتا(موقع_الشمس * ط / 180) * جتا(الزمن[:دائرة_العرض] * ط / 180))) * 180 / ط //  modلوy when add * 180 / ط 
        شوف "مستوي_الشمس$4" + سطر 
    لو الأتجاه = "ccw"
        مرر الظهيرة - معدل_التغير
    لا
        مرر الظهيرة + معدل_التغير
    تمام
     
تمام

دالة قوس_ظل_تمام_الزاوية م // قوس_ظتا
    مرر قوس_الظل(1.0 / م) * 180 / ط
تمام

دالة الوقت_العصر معامل, الوقت
    موقع_الشمس = مكان_الشمس(الزمن[:اليوم_المكاني] + الوقت)[1] // Corrected index إلى 1
    الزاوية = -قوس_ظل_تمام_الزاوية(معامل + ظا(oMath.fabs(الزمن[:دائرة_العرض] - موقع_الشمس) * ط / 180))
    مرر مستوي_الشمس(الزاوية, الوقت, "فارغ")
تمام



دالة معامل_العصر مقياس_العصر
    لو متساوي(مقياس_العصر, "Standard")
        مرر 1
    إذا متساوي(مقياس_العصر, "Hanafi")
        مرر 2
    لا
        مرر القيمة(مقياس_العصر)
    تمام
تمام

دالة زواية_المشرق تقيم_النظر
    لو تقيم_النظر = 0
        تقيم_النظر = 0
    تمام
    مرر 0.833 + 0.0347 * الجزر_التربيعي(تقيم_النظر)
تمام

دالة طرح_الأوقات الوقت1, الوقت2
    مرر مجال_الساعة(الوقت2 - الوقت1)
تمام

دالة جزء_الليل الزاوية, الليل
    الأسلوب = الزمن[:الإعدادات][:أعلي_خظ_عرض]
    الجزء = 1 / 2.0
    لو متساوي(الأسلوب, "على أساس الزاوية")
        الجزء = (1 / 60.0) * الزاوية
    إذا متساوي(الأسلوب, "OneSeventh")
        الجزء = 1 / 7.0
    تمام
    مرر الجزء * الليل
تمام

دالة تعديل_الوقت_الاتجاهي الوقت, الأساس, الزاوية, الليل, الأتجاه
    الجزء = جزء_الليل(الزاوية, الليل)
    لو الأتجاه = "ccw"
        ناتج_الطرح = طرح_الأوقات(الوقت, الأساس)
    لا
        ناتج_الطرح = طرح_الأوقات(الأساس, الوقت)
    تمام

    لو هل_غير_معرف(الوقت) or ناتج_الطرح > الجزء
        لو الأتجاه = "ccw"
            الوقت = الأساس - الجزء
        لا
            الوقت = الأساس + الجزء
        تمام
    تمام
    مرر الوقت
تمام

دالة تعديل_أعلي_خظ_عرض الاوقات
    القيم = الزمن[:الإعدادات]
    وقت_الليل = طرح_الأوقات(الاوقات[6], الاوقات[3])
    الاوقات[1] = تعديل_الوقت_الاتجاهي(الاوقات[1], الاوقات[3], القيمة(القيم[:الإمساك]), وقت_الليل, "ccw")
    الاوقات[2] = تعديل_الوقت_الاتجاهي(الاوقات[2], الاوقات[3], القيمة(القيم[:الفجر]), وقت_الليل, "ccw")
    الاوقات[8] = تعديل_الوقت_الاتجاهي(الاوقات[8], الاوقات[6], القيمة(القيم[:العشاء]), وقت_الليل, "فارغ")
    الاوقات[7] = تعديل_الوقت_الاتجاهي(الاوقات[7], الاوقات[6], القيمة(القيم[:المغرب]), وقت_الليل, "فارغ")
    مرر الاوقات
تمام

دالة تعديل_الوقت الاوقات
    القيم = الزمن[:الإعدادات]
    معدل_التغير = الزمن[:فرق_التوقيت] - الزمن[:خط_الطول] / 15.0
    من i = 1 إلى len(الاوقات)
        الاوقات[i] += معدل_التغير
    تمام

    لو ! متساوي(القيم[:أعلي_خظ_عرض] , "None")
        الاوقات = تعديل_أعلي_خظ_عرض(الاوقات)
    تمام

    لو هل_أقل(القيم[:الإمساك])
        الاوقات[1] = الاوقات[2] - القيمة(القيم[:الإمساك]) / 60.0
    تمام
    لو هل_أقل(القيم[:المغرب])
        الاوقات[7] = الاوقات[6] + القيمة(القيم[:المغرب]) / 60.0
    تمام
    لو هل_أقل(القيم[:العشاء])
        الاوقات[8] = الاوقات[7] + القيمة(القيم[:العشاء]) / 60.0
    تمام
    الاوقات[4] += القيمة(القيم[:الظهر]) / 60.0
    مرر الاوقات
تمام

دالة هل_غير_معرف رقم
    مرر رقم != رقم 
تمام



دالة مواقيت_الصلاة الاوقات
        من i = 1 إلى len(الاوقات)
                الاوقات[i] /= 24
        تمام
        شوف "مواقيت_الصلاة$1" + سطر 
        القيم = الزمن[:الإعدادات]
           شوف "مواقيت_الصلاة$الإعدادات" + سطر
        الإمساك = مستوي_الشمس(
        القيمة(القيم[:الإمساك]),
         الاوقات[1], "ccw")
        الفجر = مستوي_الشمس(القيمة(القيم[:الفجر]), الاوقات[2], "ccw")
        الشروق = مستوي_الشمس(زواية_المشرق(الزمن[:زواية_النظر_للبحر]), الاوقات[3], "ccw")
         شوف "مواقيت_الصلاة$نصف اليوم" + سطر 
        الظهر = نصف_اليوم(الاوقات[4])
             شوف "مواقيت_الصلاة$الوقت_العصر" + سطر
        العصر = الوقت_العصر(معامل_العصر(القيم[:العصر]), الاوقات[5])
         شوف "مواقيت_الصلاة$الغروب" + سطر
        الغروب = مستوي_الشمس(زواية_المشرق(الزمن[:زواية_النظر_للبحر]), الاوقات[6], "فارغ")
         شوف "مواقيت_الصلاة$المغرب" + سطر
        المغرب = مستوي_الشمس(القيمة(القيم[:المغرب]), الاوقات[7], "فارغ")
        العشاء = مستوي_الشمس(القيمة(القيم[:العشاء]), الاوقات[8], "فارغ")
        شوف "مواقيت_الصلاة$2" + سطر
        شوف [الإمساك, الفجر, الشروق, الظهر, العصر, الغروب, المغرب, العشاء, 0]
        مرر [الإمساك, الفجر, الشروق, الظهر, العصر, الغروب, المغرب, العشاء, 0]
تمام


دالة لحن_الوقت الاوقات
    من i = 1 إلى len(الاوقات) -1 // Exclude نص_اليل from tuning
        الاوقات[i] += الزمن[:قيم_زوايا][i] / 60.0
    تمام
    مرر الاوقات
تمام

دالة حساب_الأوقات
        الاوقات = [5, 5, 6, 12, 13, 18, 18, 18, 0]
        شوف "حساب_الأوقات$0" + سطر
        شوف الاوقات 
        من i = 1 إلى الزمن[:الرقم_الدوران]
                الاوقات = مواقيت_الصلاة(الاوقات)
        تمام
        شوف "حساب_الأوقات$2" + سطر
        شوف الاوقات 
        الاوقات = تعديل_الوقت(الاوقات)
        شوف "حساب_الأوقات$3" + سطر
        شوف الاوقات 
        لو متساوي(الزمن[:الإعدادات][:نص_اليل], "Jafari")
                الاوقات[9] = الاوقات[6] + طرح_الأوقات(الاوقات[6], الاوقات[2]) / 2
        لا
                الاوقات[9] = الاوقات[6] + طرح_الأوقات(الاوقات[6], الاوقات[3]) / 2
        تمام
        الاوقات = لحن_الوقت(الاوقات)
        مرر الاوقات
تمام



دالة تنسيق_رقم رقم
لو(رقم<10)
مرر "0"+رقم
لا
مرر ""+رقم
تمام
دالة جعل_الوقت_منسق الوقت, النسق, التميزات
    لو هل_غير_معرف(الوقت)
        مرر الزمن[:خطأ_التوقيت]
    تمام

    لو التميزات = فارغ
        التميزات = الزمن[:تمييز_المعاد]
    تمام

    الوقت = مجال_الساعة(الوقت + 0.5 / 60)
    الساعة = صحيح(الوقت)
    الدقائق = صحيح((الوقت - الساعة) * 60)
    لو الساعة < 12
        التميز = التميزات[1]
    لا
        التميز = التميزات[2]
    تمام

    لو متساوي(النسق, "24h")
        وقت_منسق = تنسيق_رقم(الساعة) + ":" + تنسيق_رقم(الدقائق)
    لا
        وقت_منسق = تنسيق_رقم((الساعة + 11) % 12 + 1) + ":" + تنسيق_رقم(الدقائق)
    تمام

    مرر وقت_منسق
تمام

دالة تنسيق_الأوقات الاوقات
    الأوقات_المنسقة = []
    من i = 1 إلى len(الاوقات)  الأوقات_المنسقة+ جعل_الوقت_منسق(الاوقات[i], الزمن[:نسق_الساعة], فارغ) تمام
    مرر الأوقات_المنسقة
تمام

دالة هات_الاوقات تاريخ, النقط, فرق_التوقيت, توقيت_صيفي, النسق
    الزمن[:دائرة_العرض] = النقط[1]
    الزمن[:خط_الطول] = النقط[2]
    الزمن[:زواية_النظر_للبحر] = النقط[3] 
    لو(توقيت_صيفي) فرق_التوقيت++ تم
    الزمن[:فرق_التوقيت] = فرق_التوقيت 
    الزمن[:اليوم_المكاني] = ميلادي(تاريخ[1], تاريخ[2], تاريخ[3]) - الزمن[:خط_الطول] / (15 * 24.0)
    شوف "اليوم_المكاني : " + الزمن[:اليوم_المكاني] + سطر
    الاوقات = حساب_الأوقات()
    الأوقات_المنسقة = تنسيق_الأوقات(الاوقات)

    التنتائج = [
        :الإمساك = الأوقات_المنسقة[1],
        :الفجر = الأوقات_المنسقة[2],
        :الشروق = الأوقات_المنسقة[3],
        :الظهر = الأوقات_المنسقة[4],
        :العصر = الأوقات_المنسقة[5],
        :الغروب = الأوقات_المنسقة[6],
        :المغرب = الأوقات_المنسقة[7],
        :العشاء = الأوقات_المنسقة[8],
        :نص_اليل = الأوقات_المنسقة[9]
    ]
    مرر التنتائج
تمام




دالة ضع_الأسلوب الأسلوب
    من i = 1 إلى len(الوسائل)
        لو متساوي(الوسائل[i][:الإسم], الأسلوب)
            الزمن[:الإعدادات] = الوسائل[i][:القيم]
            الزمن[:قيم_زوايا] = الوسائل[i][:قيم_زوايا]
            الزمن[:ألية_المستخدمة] = الأسلوب
            فر
        تمام
    تمام
تمام

دالة main
   
    دائرة_العرض = 30.8761
    خط_الطول = 29.7426
    الأسلوب = "مصر"
    الطول_الزمني_بالساعات = 2 
    التوقيت_الصيفي = 0 
    لو التوقيت_الصيفي = فارغ التوقيت_الصيفي = 0 تم
    لو الطول_الزمني_بالساعات = فارغ الطول_الزمني_بالساعات = 0 تم

    ضع_الأسلوب(الأسلوب)
    شوف الأن
    تاريخ = [القيمة(الأن[19]),القيمة(الأن[10]),القيمة(الأن[6])]
    النقط = [دائرة_العرض, خط_الطول, 0]
  
    الاوقات = هات_الاوقات(تاريخ, النقط, الطول_الزمني_بالساعات, التوقيت_الصيفي, "")

    شوف "الفجر: " + الاوقات[:الفجر] + سطر
    شوف "الظهر: " + الاوقات[:الظهر] + سطر
    شوف "العصر: " + الاوقات[:العصر] + سطر
    شوف "المغرب: " + الاوقات[:المغرب] + سطر
    شوف "العشاء: " + الاوقات[:العشاء] + سطر

    شوف التاريخ() + سطر
تمام 




